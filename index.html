<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Manuscript Scorer - Projects</title>
  <link rel="stylesheet" href="index.css">
  <script src="file-system.js"></script>
</head>
<body>
  <header class="header">
    <h1>Manuscript Scorer</h1>
    <div class="header-right">
      <div id="status" class="gdrive-status">
        <span id="status-indicator" class="gdrive-indicator connected"></span>
        <span id="status-text">Local Storage</span>
      </div>
    </div>
  </header>

  <main class="content">
    <div id="projects-container" class="projects-container">
      <p class="subtitle">Select a project to open</p>
      <div class="projects-grid" id="projects-grid">
        <!-- Projects loaded dynamically -->
      </div>

      <div class="new-project">
        <button id="new-project-btn" class="new-project-btn">+ New Project</button>
        <button id="open-project-btn" class="open-shared-btn">Open Project</button>
      </div>
    </div>
  </main>

  <!-- Folder Preview Dialog -->
  <dialog id="folder-preview-dialog" class="dialog folder-preview-dialog">
    <h2>Folder Contents</h2>
    <div class="folder-info">
      <p><strong>Folder:</strong> <span id="preview-folder-name"></span></p>
    </div>
    <div class="folder-contents">
      <div class="contents-section">
        <h3>Manuscript Files (<span id="preview-file-count">0</span>)</h3>
        <ul id="preview-file-list" class="preview-file-list"></ul>
      </div>
      <div id="preview-existing-project" class="contents-section hidden">
        <h3>Existing Project Data</h3>
        <ul id="preview-existing-list" class="preview-file-list"></ul>
      </div>
    </div>
    <label class="project-name-input">
      Project Name
      <input type="text" id="preview-project-name" placeholder="Enter project name">
    </label>
    <div class="dialog-actions">
      <button type="button" id="preview-cancel-btn">Cancel</button>
      <button type="button" id="preview-confirm-btn" class="btn-primary">Open Project</button>
    </div>
  </dialog>

  <script>
    const projectsGrid = document.getElementById('projects-grid');
    const projectsContainer = document.getElementById('projects-container');
    const newProjectBtn = document.getElementById('new-project-btn');
    const openProjectBtn = document.getElementById('open-project-btn');

    // Check if File System Access API is supported
    const hasFileSystemAccess = FileSystem.isSupported();

    // Load projects from IndexedDB
    async function loadProjects() {
      if (!hasFileSystemAccess) {
        projectsGrid.innerHTML = `
          <div class="error-message">
            <p>Your browser does not support the File System Access API.</p>
            <p>Please use Chrome, Edge, or another Chromium-based browser.</p>
          </div>
        `;
        return;
      }

      try {
        const projects = await FileSystem.getSavedProjects();
        renderProjects(projects);
      } catch (err) {
        console.error('Error loading projects:', err);
        projectsGrid.innerHTML = `
          <div class="error-message">
            <p>Could not load projects.</p>
            <p>${escapeHtml(err.message)}</p>
          </div>
        `;
      }
    }

    // Render project cards
    function renderProjects(projects) {
      if (projects.length === 0) {
        projectsGrid.innerHTML = `
          <div class="empty-message">
            <p>No projects yet.</p>
            <p>Create your first project to get started.</p>
          </div>
        `;
        return;
      }

      projectsGrid.innerHTML = projects.map(project => `
        <div class="project-card" data-project-id="${escapeHtml(project.id)}">
          <button class="project-link" data-action="open">
            <h3>${escapeHtml(project.name)}</h3>
            <p class="project-meta">Click to open (requires permission)</p>
          </button>
          <button class="project-settings-btn" data-action="manage" title="Project settings">&#9881;</button>
          <button class="project-remove-btn" data-action="remove" title="Remove from list">&times;</button>
        </div>
      `).join('');

      // Add click handlers for project cards
      projectsGrid.querySelectorAll('.project-card').forEach(card => {
        const projectId = card.dataset.projectId;

        card.querySelector('[data-action="open"]').addEventListener('click', () => openProject(projectId));
        card.querySelector('[data-action="manage"]').addEventListener('click', () => manageProject(projectId));
        card.querySelector('[data-action="remove"]').addEventListener('click', (e) => {
          e.stopPropagation();
          removeProject(projectId);
        });
      });
    }

    // Open a saved project (request permission and navigate)
    async function openProject(projectId) {
      try {
        const projects = await FileSystem.getSavedProjects();
        const project = projects.find(p => p.id === projectId);
        if (!project) {
          alert('Project not found');
          return;
        }

        // Request permission for the folder
        const granted = await FileSystem.requestPermission(project.handle);
        if (!granted) {
          alert('Permission denied. Please grant access to the folder.');
          return;
        }

        // Store the project ID in sessionStorage so scorer.html can retrieve it
        sessionStorage.setItem('currentProjectId', projectId);
        window.location.href = 'scorer.html';
      } catch (err) {
        console.error('Error opening project:', err);
        alert('Failed to open project: ' + err.message);
      }
    }

    // Navigate to manage page
    async function manageProject(projectId) {
      try {
        const projects = await FileSystem.getSavedProjects();
        const project = projects.find(p => p.id === projectId);
        if (!project) {
          alert('Project not found');
          return;
        }

        const granted = await FileSystem.requestPermission(project.handle);
        if (!granted) {
          alert('Permission denied. Please grant access to the folder.');
          return;
        }

        sessionStorage.setItem('currentProjectId', projectId);
        window.location.href = 'manage.html';
      } catch (err) {
        console.error('Error opening project settings:', err);
        alert('Failed to open project settings: ' + err.message);
      }
    }

    // Remove project from list (doesn't delete files)
    async function removeProject(projectId) {
      if (!confirm('Remove this project from the list? (Files will not be deleted)')) {
        return;
      }

      try {
        await FileSystem.removeProject(projectId);
        loadProjects();
      } catch (err) {
        console.error('Error removing project:', err);
        alert('Failed to remove project: ' + err.message);
      }
    }

    // Escape HTML
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // New project button - uses File System Access API
    newProjectBtn.addEventListener('click', async () => {
      if (!hasFileSystemAccess) {
        alert('Your browser does not support the File System Access API. Please use Chrome or Edge.');
        return;
      }

      try {
        const dirHandle = await window.showDirectoryPicker({
          mode: 'readwrite'
        });

        const folderName = dirHandle.name;
        const projectName = prompt(`Creating new project in folder: ${folderName}\n\nEnter a name for this project:`, folderName);
        if (!projectName) return;

        // Initialize project structure in selected folder
        const { config, sigla } = await FileSystem.initializeProject(dirHandle, projectName);

        // Save to IndexedDB
        const projectId = FileSystem.generateProjectId();
        await FileSystem.saveProject(projectId, dirHandle, projectName);

        // Store project ID and navigate to scorer
        sessionStorage.setItem('currentProjectId', projectId);
        window.location.href = 'scorer.html';

      } catch (err) {
        if (err.name === 'AbortError') return;
        console.error('Error creating project:', err);
        alert('Failed to create project: ' + err.message);
      }
    });

    // Open project button - uses File System Access API with preview dialog
    const previewDialog = document.getElementById('folder-preview-dialog');
    const previewFolderName = document.getElementById('preview-folder-name');
    const previewFileCount = document.getElementById('preview-file-count');
    const previewFileList = document.getElementById('preview-file-list');
    const previewExistingProject = document.getElementById('preview-existing-project');
    const previewExistingList = document.getElementById('preview-existing-list');
    const previewProjectName = document.getElementById('preview-project-name');
    const previewCancelBtn = document.getElementById('preview-cancel-btn');
    const previewConfirmBtn = document.getElementById('preview-confirm-btn');

    let pendingDirHandle = null;

    // Scan folder for all contents
    async function scanFolderContents(dirHandle) {
      const result = {
        txtFiles: [],
        hasProjectJson: false,
        hasScoreData: false,
        hasScoreTxt: false,
        hasManuscriptsFolder: false,
        projectName: null
      };

      for await (const entry of dirHandle.values()) {
        if (entry.kind === 'file') {
          if (entry.name === 'project.json') {
            result.hasProjectJson = true;
            try {
              const file = await entry.getFile();
              const config = JSON.parse(await file.text());
              result.projectName = config.name;
            } catch (e) {}
          } else if (entry.name === 'score-data.json') {
            result.hasScoreData = true;
          } else if (entry.name === 'score.txt') {
            result.hasScoreTxt = true;
          } else if (entry.name.endsWith('.txt')) {
            result.txtFiles.push(entry.name.replace('.txt', ''));
          }
        } else if (entry.kind === 'directory' && entry.name === 'manuscripts') {
          result.hasManuscriptsFolder = true;
        }
      }

      // If manuscripts folder exists, get files from there instead
      if (result.hasManuscriptsFolder) {
        result.txtFiles = [];
        const msHandle = await dirHandle.getDirectoryHandle('manuscripts');
        for await (const entry of msHandle.values()) {
          if (entry.kind === 'file' && entry.name.endsWith('.txt')) {
            result.txtFiles.push(entry.name.replace('.txt', ''));
          }
        }
      }

      return result;
    }

    // Show preview dialog
    function showFolderPreview(folderName, contents) {
      previewFolderName.textContent = folderName;
      previewFileCount.textContent = contents.txtFiles.length;

      // Show manuscript files
      if (contents.txtFiles.length > 0) {
        previewFileList.innerHTML = contents.txtFiles
          .sort()
          .map(f => `<li>${escapeHtml(f)}.txt</li>`)
          .join('');
      } else {
        previewFileList.innerHTML = '<li style="background:#ffebee;color:#c62828;">No .txt files found</li>';
      }

      // Show existing project data if any
      const existingItems = [];
      if (contents.hasProjectJson) existingItems.push('project.json');
      if (contents.hasScoreData) existingItems.push('score-data.json');
      if (contents.hasScoreTxt) existingItems.push('score.txt');
      if (contents.hasManuscriptsFolder) existingItems.push('manuscripts/');

      if (existingItems.length > 0) {
        previewExistingProject.classList.remove('hidden');
        previewExistingList.innerHTML = existingItems
          .map(f => `<li class="existing-file">${escapeHtml(f)}</li>`)
          .join('');
      } else {
        previewExistingProject.classList.add('hidden');
      }

      // Set default project name
      previewProjectName.value = contents.projectName || folderName;

      // Enable/disable confirm button
      previewConfirmBtn.disabled = contents.txtFiles.length === 0;

      previewDialog.showModal();
    }

    openProjectBtn.addEventListener('click', async () => {
      if (!hasFileSystemAccess) {
        alert('Your browser does not support the File System Access API. Please use Chrome or Edge.');
        return;
      }

      try {
        const dirHandle = await window.showDirectoryPicker({
          mode: 'readwrite'
        });

        // Scan folder contents
        const contents = await scanFolderContents(dirHandle);

        // Store handle for later use
        pendingDirHandle = dirHandle;

        // Show preview dialog
        showFolderPreview(dirHandle.name, contents);

      } catch (err) {
        if (err.name === 'AbortError') return;
        console.error('Error selecting folder:', err);
        alert('Failed to read folder: ' + err.message);
      }
    });

    // Cancel preview
    previewCancelBtn.addEventListener('click', () => {
      previewDialog.close();
      pendingDirHandle = null;
    });

    // Confirm and open project
    previewConfirmBtn.addEventListener('click', async () => {
      if (!pendingDirHandle) return;

      const projectName = previewProjectName.value.trim();
      if (!projectName) {
        alert('Please enter a project name');
        return;
      }

      try {
        previewConfirmBtn.disabled = true;
        previewConfirmBtn.textContent = 'Opening...';

        // Initialize project structure
        await FileSystem.initializeProject(pendingDirHandle, projectName);

        // Save to IndexedDB
        const projectId = FileSystem.generateProjectId();
        await FileSystem.saveProject(projectId, pendingDirHandle, projectName);

        // Store project ID and navigate to scorer
        sessionStorage.setItem('currentProjectId', projectId);
        window.location.href = 'scorer.html';

      } catch (err) {
        console.error('Error opening project:', err);
        alert('Failed to open project: ' + err.message);
        previewConfirmBtn.disabled = false;
        previewConfirmBtn.textContent = 'Open Project';
      }
    });

    // Close dialog on backdrop click
    previewDialog.addEventListener('click', (e) => {
      if (e.target === previewDialog) {
        previewDialog.close();
        pendingDirHandle = null;
      }
    });

    // Load projects on page load
    loadProjects();
  </script>
</body>
</html>
