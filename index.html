<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Manuscript Scorer - Projects</title>
  <link rel="stylesheet" href="index.css">
  <script src="file-system.js"></script>
</head>
<body>
  <header class="header">
    <h1>Manuscript Scorer</h1>
    <div class="header-right">
      <div id="status" class="gdrive-status">
        <span id="status-indicator" class="gdrive-indicator connected"></span>
        <span id="status-text">Local Storage</span>
      </div>
    </div>
  </header>

  <main class="content">
    <div id="projects-container" class="projects-container">
      <p class="subtitle">Select a project to open</p>
      <div class="projects-grid" id="projects-grid">
        <!-- Projects loaded dynamically -->
      </div>

      <div class="new-project">
        <button id="new-project-btn" class="new-project-btn">+ New Project</button>
        <button id="open-project-btn" class="open-shared-btn">Open Project</button>
      </div>
    </div>
  </main>



  <script>
    const projectsGrid = document.getElementById('projects-grid');
    const projectsContainer = document.getElementById('projects-container');
    const newProjectBtn = document.getElementById('new-project-btn');
    const openProjectBtn = document.getElementById('open-project-btn');

    // Check if File System Access API is supported
    const hasFileSystemAccess = FileSystem.isSupported();

    // Load projects from IndexedDB
    async function loadProjects() {
      if (!hasFileSystemAccess) {
        projectsGrid.innerHTML = `
          <div class="error-message">
            <p>Your browser does not support the File System Access API.</p>
            <p>Please use Chrome, Edge, or another Chromium-based browser.</p>
          </div>
        `;
        return;
      }

      try {
        const projects = await FileSystem.getSavedProjects();
        renderProjects(projects);
      } catch (err) {
        console.error('Error loading projects:', err);
        projectsGrid.innerHTML = `
          <div class="error-message">
            <p>Could not load projects.</p>
            <p>${escapeHtml(err.message)}</p>
          </div>
        `;
      }
    }

    // Render project cards
    function renderProjects(projects) {
      if (projects.length === 0) {
        projectsGrid.innerHTML = `
          <div class="empty-message">
            <p>No projects yet.</p>
            <p>Create your first project to get started.</p>
          </div>
        `;
        return;
      }

      projectsGrid.innerHTML = projects.map(project => `
        <div class="project-card" data-project-id="${escapeHtml(project.id)}">
          <button class="project-link" data-action="open">
            <h3>${escapeHtml(project.name)}</h3>
            <p class="project-meta">Click to open (requires permission)</p>
          </button>
          <button class="project-settings-btn" data-action="manage" title="Project settings">&#9881;</button>
          <button class="project-remove-btn" data-action="remove" title="Remove from list">&times;</button>
        </div>
      `).join('');

      // Add click handlers for project cards
      projectsGrid.querySelectorAll('.project-card').forEach(card => {
        const projectId = card.dataset.projectId;

        card.querySelector('[data-action="open"]').addEventListener('click', () => openProject(projectId));
        card.querySelector('[data-action="manage"]').addEventListener('click', () => manageProject(projectId));
        card.querySelector('[data-action="remove"]').addEventListener('click', (e) => {
          e.stopPropagation();
          removeProject(projectId);
        });
      });
    }

    // Open a saved project (request permission and navigate)
    async function openProject(projectId) {
      try {
        const projects = await FileSystem.getSavedProjects();
        const project = projects.find(p => p.id === projectId);
        if (!project) {
          alert('Project not found');
          return;
        }

        // Request permission for the folder
        const granted = await FileSystem.requestPermission(project.handle);
        if (!granted) {
          alert('Permission denied. Please grant access to the folder.');
          return;
        }

        // Store the project ID in sessionStorage so scorer.html can retrieve it
        sessionStorage.setItem('currentProjectId', projectId);
        window.location.href = 'scorer.html';
      } catch (err) {
        console.error('Error opening project:', err);
        alert('Failed to open project: ' + err.message);
      }
    }

    // Navigate to manage page
    async function manageProject(projectId) {
      try {
        const projects = await FileSystem.getSavedProjects();
        const project = projects.find(p => p.id === projectId);
        if (!project) {
          alert('Project not found');
          return;
        }

        const granted = await FileSystem.requestPermission(project.handle);
        if (!granted) {
          alert('Permission denied. Please grant access to the folder.');
          return;
        }

        sessionStorage.setItem('currentProjectId', projectId);
        window.location.href = 'manage.html';
      } catch (err) {
        console.error('Error opening project settings:', err);
        alert('Failed to open project settings: ' + err.message);
      }
    }

    // Remove project from list (doesn't delete files)
    async function removeProject(projectId) {
      if (!confirm('Remove this project from the list? (Files will not be deleted)')) {
        return;
      }

      try {
        await FileSystem.removeProject(projectId);
        loadProjects();
      } catch (err) {
        console.error('Error removing project:', err);
        alert('Failed to remove project: ' + err.message);
      }
    }

    // Escape HTML
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // New project button - uses File System Access API
    newProjectBtn.addEventListener('click', async () => {
      if (!hasFileSystemAccess) {
        alert('Your browser does not support the File System Access API. Please use Chrome or Edge.');
        return;
      }

      try {
        const dirHandle = await window.showDirectoryPicker({
          mode: 'readwrite'
        });

        const folderName = dirHandle.name;
        const projectName = prompt(`Creating new project in folder: ${folderName}\n\nEnter a name for this project:`, folderName);
        if (!projectName) return;

        // Initialize project structure in selected folder
        const { config, sigla } = await FileSystem.initializeProject(dirHandle, projectName);

        // Save to IndexedDB
        const projectId = FileSystem.generateProjectId();
        await FileSystem.saveProject(projectId, dirHandle, projectName);

        // Store project ID and navigate to scorer
        sessionStorage.setItem('currentProjectId', projectId);
        window.location.href = 'scorer.html';

      } catch (err) {
        if (err.name === 'AbortError') return;
        console.error('Error creating project:', err);
        alert('Failed to create project: ' + err.message);
      }
    });

    // Open project button - uses File System Access API
    openProjectBtn.addEventListener('click', async () => {
      if (!hasFileSystemAccess) {
        alert('Your browser does not support the File System Access API. Please use Chrome or Edge.');
        return;
      }

      try {
        const dirHandle = await window.showDirectoryPicker({
          mode: 'readwrite'
        });

        const folderName = dirHandle.name;

        // Check what exists in the folder
        const { txtFiles, hasManuscriptsFolder } = await FileSystem.listTxtFiles(dirHandle);

        // Validate: need at least one .txt file
        if (txtFiles.length === 0) {
          alert('No .txt manuscript files found in this folder.\n\nPlease select a folder containing at least one .txt file.');
          return;
        }

        // Ask for project name
        const projectName = prompt(`Opening folder: ${folderName}\n\nFound ${txtFiles.length} manuscript file(s).\n\nEnter a name for this project:`, folderName);
        if (!projectName) return;

        // Initialize project structure (creates manuscripts/, project.json, index.json if needed)
        await FileSystem.initializeProject(dirHandle, projectName);

        // Save to IndexedDB
        const projectId = FileSystem.generateProjectId();
        await FileSystem.saveProject(projectId, dirHandle, projectName);

        // Store project ID and navigate to scorer
        sessionStorage.setItem('currentProjectId', projectId);
        window.location.href = 'scorer.html';

      } catch (err) {
        if (err.name === 'AbortError') return;
        console.error('Error opening project:', err);
        alert('Failed to open project: ' + err.message);
      }
    });

    // Load projects on page load
    loadProjects();
  </script>
</body>
</html>
